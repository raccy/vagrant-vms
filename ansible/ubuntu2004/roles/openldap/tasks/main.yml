- name: debconf shared/organization
  become: yes
  debconf:
    name: slapd
    question: shared/organization
    value: example
    vtype: string

- name: debconf slapd/domain
  become: yes
  debconf:
    name: slapd
    question: slapd/domain
    value: example.jp
    vtype: string

- name: debconf slapd/password
  become: yes
  debconf:
    name: slapd
    question: '{{ item }}'
    value: admin_password
    vtype: password
  loop:
    - slapd/password1
    - slapd/password2

- name: apt install slapd
  become: yes
  apt:
    name: slapd
    state: present

- name: start slapd
  become: yes
  systemd:
    name: slapd.service
    enabled: yes
    state: started

- name: apt install pkgs for ldap
  become: yes
  apt:
    pkg:
      - ldap-utils
      - python3-ldap

- name: ldap entry people ou
  ldap_entry:
    state: present
    dn: 'ou=people,dc=example,dc=jp'
    objectClass:
      - organizationalUnit
      - top
  args: '{{ ldap_auth }}'

- name: ldap entry groups ou
  ldap_entry:
    state: present
    dn: 'ou=groups,dc=example,dc=jp'
    objectClass:
      - organizationalUnit
      - top
  args: '{{ ldap_auth }}'

- import_tasks: user_group.yml

# - name: check slapcat
#   become: yes
#   command:
#     cmd: slapcat
#   register: slapcat_result

# - name: ldapadd
#   become: yes
#   command:
#     argv:
#       - ldapadd
#       - -x
#       - -h
#       - localhost
#       - -p
#       - '389'
#       - -D
#       - 'cn=admin,dc=example,dc=jp'
#       - -w
#       - admin_password
#       - -f
#       - /var/tmp/openldap-setup/user_group.ldif'
#   when: 'not "dn: uid=admin,ou=people,dc=example,dc=jp" in slapcat_result.stdout_lines'
